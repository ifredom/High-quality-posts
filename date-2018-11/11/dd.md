# 走向自然语言语义代码搜索
```bash
title: 走向自然语言语义代码搜索
date: 2018-11-08 11:57:02
tags:
categories:
```

Github 正在测试语义搜索，匹配的依据不再是关键字，而是搜索的语义。比如，搜索"连接两个字符串"，就会跳出相关的代码。本文介绍实现细节。
[原文链接（英文）](https://githubengineering.com/towards-natural-language-semantic-code-search/)

## 正文

动机
在GitHub上搜索代码目前仅限于关键字搜索。这假定用户知道语法，或者可以预测围绕他们正在寻找的代码的注释中可能存在哪些关键字。我们的机器学习科学家一直在研究如何实现代码的语义搜索。

要完全掌握语义搜索的概念，请考虑以下搜索查询“ping REST api并返回结果”：

矢量空间图

请注意，即使搜索查询与文本之间没有共同的关键字，所展示的语义搜索也会返回合理的结果（找到的代码和注释不包含单词“Ping”，“REST”或“api”）！使用语义搜索来增强关键字搜索的意义是深远的。例如，这种能力将加速新软件工程师加入项目的过程，并加强一般代码的可发现性。

在这篇文章中，我们想分享我们如何利用深度学习来实现这一目标。 我们还分享了一个开源示例，其中包含可用于重现这些结果的代码和数据！

介绍
GitHub正在进行的机器学习研究的关键领域之一是实体的表示学习，例如回购，代码，问题，简介和用户。通过学习共享公共向量空间作为文本的代码表示，我们在实现语义搜索方面取得了重大进展。例如，请考虑下图：

矢量空间图

在上面的例子中，Text 2（蓝色）是代码的合理描述，而Text 1（红色）根本不与代码相关。我们的目标是学习表示描述相同概念的（文本，代码）对是近邻的表示，而无关（文本，代码）对则更远。通过在同一向量空间中表示文本和代码，我们可以向量化用户的搜索查询并查找代表代码的最近邻居。以下是我们目前用于完成此任务的方法的四部分描述：

1.学习代码表示
为了学习代码的表示，我们训练了一个序列到序列的模型，学习总结代码。为Python实现此目的的一种方法是提供（代码，docstring）对，其中docstring是模型试图预测的目标变量。对我们来说，一个活跃的研究领域是结合领域特定的优化，如基于树的LSTM，门控图网络和语法感知标记化。下面是一个屏幕截图，展示了工作中的代码摘要模型。在这个例子中，有两个python函数作为输入提供，在这两种情况下，模型生成一个合理的代码汇总作为输出：

代码摘要

应当注意，在上面的示例中，模型通过使用整个代码blob而不仅仅是函数名称来生成摘要。

构建代码摘要器本身就是一个非常令人兴奋的项目，但是，我们可以利用此模型中的编码器作为代码的通用功能提取器。从该模型中提取编码器后，我们可以对其进行微调，以便将代码映射到自然语言的向量空间。

我们可以使用BLEU评分客观地评估该模型。目前，我们已经能够在一组保存的python代码上获得13.5的BLEU分数，使用fairseq-py库进行序列到序列模型。

2.学习语篇短语的表示
除了学习代码表示之外，我们还需要为短语找到合适的表示（比如Python文档字符串中的句子）。最初，我们尝试使用Universal Sentence Encoder，这是TensorFlow Hub上可用的预训练编码器。虽然嵌入式工作得相当好，但我们发现学习嵌入式软件开发的词汇和语义是特别有利的。正在进行的研究的一个领域涉及评估不同领域特定的语料库，以便训练我们自己的模型，从GitHub问题到第三方数据集。

为了学习这种短语的表示，我们通过利用fast.ai库来训练神经语言模型。该库使我们可以轻松访问最先进的架构，如AWD LSTM，以及诸如随机重启的循环学习速率等技术。我们通过使用发现CONCAT池的做法，总结隐藏的状态中提取从这个模型短语表示此文件。

这项练习最具挑战性的方面之一是评估这些嵌入的质量。我们目前正在构建各种类似于此处概述的下游监督任务，这将有助于我们客观地评估这些嵌入的质量。与此同时，我们通过手动检查相似短语之间的相似性来检查我们的嵌入。下面的屏幕截图说明了我们在矢量化文档字符串中搜索与用户提供的短语相似性的示例：

vec sim

3.将代码表示映射到与文本相同的向量空间
接下来，我们将从代码汇总模型（第1部分）学到的代码表示映射到文本的向量空间。我们通过微调这个模型的编码器来实现这一目标。此模型的输入仍然是代码blob，但是模型的目标变量现在是docstrings的矢量化版本。这些文档字符串使用上一节中讨论的方法进行矢量化。

具体地说，我们使用余弦邻近损失进行多维回归，以使编码器的隐藏状态与文本处于同一向量空间。

我们正在积极研究直接学习代码和自然语言的联合向量空间的替代方法，借鉴这里概述的一些想法。

4.创建语义搜索系统
最后，在成功创建可以将代码矢量化为与文本相同的向量空间的模型之后，我们可以创建语义搜索机制。在最简单的形式中，我们可以将所有代码的矢量化版本存储在数据库中，并对矢量化搜索查询执行最近邻居查找。

我们研究的另一个活跃领域是确定使用语义结果扩充现有关键字搜索的最佳方法，以及如何合并其他信息，如上下文和相关性。此外，我们正在积极探索评估搜索结果质量的方法，以便我们快速迭代此问题。我们将这些主题留待以后的博客中讨论。

摘要
下图总结了当前语义搜索工作流程中的所有步骤：

代码摘要

我们正在探索改进该方法的几乎所有组件的方法，包括数据准备，模型架构，评估程序和整体系统设计。这篇博客文章中描述的内容只是一个最小的例子。

开源示例
我们的开源端到端教程包含本博客中概述的方法的详细演练，以及可用于重现结果的代码和数据。

这个开源示例（带有一些修改）也用作kubeflow项目的教程，该项目在此处实现。

限制和预期用例
我们认为语义代码搜索对于特定实体（如repos，组织或用户）内的代码的目标搜索最有用，而不是通用的“如何”查询。在我们最近公布的Experiments网站上托管的语义代码搜索的现场演示不允许用户对repos进行有针对性的搜索。相反，此演示旨在分享可能的内容，并仅搜索有限的静态python代码集。

此外，与所有机器学习技术一样，这种方法的功效受到所使用的训练数据的限制。例如，用于训练这些模型的数据是（代码，文档串）对。因此，与文档字符串非常相似的搜索查询最有可能获得成功。另一方面，不类似文档字符串或包含数据很少的概念的查询可能无法产生合理的结果。因此，挑战我们的现场演示并发现这种方法的局限性并不困难。尽管如此，我们的初步结果表明，这是一个非常富有成效的研究领域，我们很高兴与您分享。

语义代码搜索有更多用例。例如，我们可以扩展这里提出的想法，以允许用户同时使用他们选择的语言（法语，普通话，阿拉伯语等）跨多种不同的编程语言搜索代码。

保持联系
对于GitHub的机器学习研究团队来说，这是一个激动人心的时刻，我们正在寻求扩展。如果我们的工作让您感兴趣，请与我们联系！